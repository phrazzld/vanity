# ADR-002: Next.js Image Optimization SSRF Vulnerability Mitigation

**Date**: 2025-01-05  
**Status**: Implemented  
**Deciders**: Security Team, Development Team

## Context

A critical Server-Side Request Forgery (SSRF) vulnerability was discovered in Next.js versions 15.4.6 to 15.5.1, specifically affecting the built-in image optimization feature when using wildcard patterns in remote image configurations.

### Vulnerability Details

- **CVE**: Pending assignment
- **Severity**: Critical (CVSS 8.5)
- **Affected Versions**: Next.js 15.4.6 - 15.5.1
- **Attack Vector**: Remote exploitation via image optimization endpoint
- **Impact**: Potential access to internal network resources and metadata endpoints

### Current Implementation

Our application's `next.config.ts` contained wildcard patterns that allowed images from any domain:

```typescript
// VULNERABLE CONFIGURATION
images: {
  remotePatterns: [
    { protocol: 'https', hostname: '**' },
    { protocol: 'http', hostname: '**' },
  ];
}
```

This configuration exposed the application to SSRF attacks where malicious actors could:

1. Access internal IP addresses (127.0.0.1, 169.254.169.254)
2. Reach private network resources (10.x, 172.16-31.x, 192.168.x)
3. Query cloud metadata endpoints (AWS, GCP, Azure)
4. Potentially exfiltrate sensitive information

### Business Context

- **Application Type**: Public-facing personal website
- **Image Sources**: Book covers from specific CDN domains
- **Security Requirements**: Prevent unauthorized internal network access
- **Performance Requirements**: Maintain fast image loading from approved sources

## Decision

Implement a multi-layered defense strategy combining Next.js configuration hardening and application-level validation.

### 1. Configuration-Level Protection

Replace wildcard patterns with explicit domain allowlist in `next.config.ts`:

```typescript
// SECURE CONFIGURATION
images: {
  remotePatterns: [
    { protocol: 'https', hostname: 'm.media-amazon.com', pathname: '/**' },
    { protocol: 'https', hostname: 'images-na.ssl-images-amazon.com', pathname: '/**' },
    { protocol: 'https', hostname: 'cdn11.bigcommerce.com', pathname: '/**' },
    { protocol: 'https', hostname: 'i.pinimg.com', pathname: '/**' },
    { protocol: 'https', hostname: 'resizing.flixster.com', pathname: '/**' },
  ];
}
```

### 2. Application-Level Validation

Implement comprehensive URL validation in `validateImageUrl()` function:

- **Protocol Enforcement**: HTTPS-only for external images
- **IP Range Blocking**: Reject internal/private IP addresses
  - 127.0.0.0/8 (loopback)
  - 169.254.0.0/16 (link-local)
  - 10.0.0.0/8 (private)
  - 172.16.0.0/12 (private)
  - 192.168.0.0/16 (private)
- **Hostname Validation**: Block localhost and internal hostname variations
- **Domain Allowlisting**: Only permit 5 pre-approved CDN domains
- **Port Restriction**: Reject URLs with explicit port specifications
- **Length Limits**: Prevent excessively long URLs (>1000 chars)

### 3. Upgrade Strategy

- Upgrade Next.js from 15.4.6 to 15.5.2+ (includes security patches)
- Maintain compatibility with existing React 19.0.0 setup
- Preserve static site generation capabilities

## Consequences

### Positive

1. **Security Hardening**: Eliminates SSRF attack vectors completely
2. **Defense in Depth**: Multiple validation layers provide redundancy
3. **Performance Neutral**: No impact on image loading performance
4. **Maintainable**: Clear, documented security boundaries
5. **Testable**: Comprehensive test coverage (23 security test cases)

### Negative

1. **Reduced Flexibility**: New image sources require code changes
2. **Maintenance Overhead**: Domain list must be kept current
3. **Breaking Change**: External images outside allowlist will fail

### Trade-offs Accepted

- **Security over Convenience**: Manual domain updates preferred over vulnerability exposure
- **Explicit over Implicit**: Verbose configuration for clear security boundaries
- **Fail Secure**: Reject uncertain URLs rather than risk exposure

## Implementation Details

### Files Modified

1. **next.config.ts**: Replaced wildcard patterns with domain allowlist
2. **src/lib/utils/readingUtils.ts**: Added `validateImageUrl()` function
3. **src/app/components/**tests**/ImageSecurity.test.tsx**: Created comprehensive test suite
4. **package.json**: Upgraded Next.js to 15.5.2

### Testing Strategy

- Unit tests for all validation scenarios
- Manual testing with production image URLs
- Security testing with known SSRF payloads
- CI/CD integration for continuous validation

### Rollback Plan

If issues occur post-deployment:

1. **Immediate**: Vercel dashboard rollback to previous deployment
2. **Git-based**: `git revert` and push to trigger redeployment
3. **Emergency**: Force push previous commit (last resort)

## Lessons Learned

1. **Default Security**: Never use wildcard patterns in production configurations
2. **Domain Inventory**: Maintain accurate list of external dependencies
3. **Proactive Monitoring**: Implement security scanning in CI pipeline
4. **Defense Layers**: Single point of failure prevention through redundancy

## References

- [Next.js Security Advisory](https://github.com/vercel/next.js/security)
- [OWASP SSRF Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html)
- [CWE-918: Server-Side Request Forgery](https://cwe.mitre.org/data/definitions/918.html)

## Status Updates

- **2025-01-05**: Initial implementation completed
- **2025-01-05**: All tests passing (337 total, 23 security-specific)
- **2025-01-05**: Deployed to fix/next-js-ssrf-vulnerability branch
- **Pending**: Production deployment after PR review
