# Security Vulnerability Management Guide

## Overview

This document outlines the approach to managing security vulnerabilities in dependencies for the Vanity project. We use npm's built-in audit capabilities enhanced with a custom allowlisting mechanism to manage and track known vulnerabilities.

## Vulnerability Scanning

### Automated Scanning in CI

The project includes automated security vulnerability scanning in the CI pipeline that:

1. Runs on every pull request and push to main
2. Checks for high and critical vulnerabilities using `npm audit`
3. Uses an allowlist mechanism to handle known and accepted vulnerabilities
4. Fails the build when new high or critical vulnerabilities are detected

### Local Scanning

Developers can run the same security checks locally using:

```bash
# Run a basic high/critical vulnerability scan
npm run security:audit

# Run the scan with allowlist filtering (same as CI)
npm run security:scan
```

## Understanding Audit Results

npm audit categorizes vulnerabilities by severity:

- **Low**: Minimal impact, generally safe to defer remediation
- **Moderate**: Notable security impact but typically not exploitable in most contexts
- **High**: Significant security impact, should be prioritized for remediation
- **Critical**: Severe vulnerabilities that require immediate attention

Our CI pipeline fails on **high** and **critical** vulnerabilities only, unless they're in the allowlist.

## Vulnerability Allowlisting

### When to Use Allowlisting

Allowlisting should be used in the following scenarios:

1. A vulnerability exists in a development dependency not used in production
2. A vulnerability is not exploitable in our specific usage context
3. A fix is not yet available, but we have a timeline for remediation

### Allowlist Configuration

The allowlist is managed in `.audit-allowlist.json` in the project root. Each entry includes:

```json
{
  "id": "GHSA-xxxx-xxxx-xxxx",
  "package": "example-package",
  "reason": "Justification for allowing this vulnerability",
  "notes": "Optional additional context",
  "expires": "2025-12-31",
  "reviewedOn": "2025-05-20"
}
```

**Required fields:**

- `id`: The vulnerability identifier (from npm audit)
- `package`: The package name containing the vulnerability
- `reason`: A clear justification for allowlisting

**Optional fields:**

- `notes`: Additional context or references
- `expires`: An ISO 8601 date (YYYY-MM-DD) when this allowlist entry expires
- `reviewedOn`: The date when this allowlist entry was last reviewed

### Adding a New Allowlist Entry

When adding a new entry to the allowlist:

1. Run `npm audit` to identify the vulnerability details
2. Add an entry to `.audit-allowlist.json` with a clear justification
3. Always include an expiration date for accountability
4. Commit the changes with a message that explains the allowlisting decision

### Expiration and Review

Allowlist entries should be temporary. The expiration date serves as a forcing function to revisit the vulnerability. When an entry expires:

1. The CI build will start failing
2. The team must either:
   - Fix the vulnerability
   - Update the expiration date with justification
   - Remove the entry if it's no longer relevant

## Remediation Workflow

When new vulnerabilities are detected:

1. **Assess impact**: Determine the severity and exploitability in your context
2. **Remediate**: Update dependencies to versions without the vulnerability
3. **Allowlist if needed**: If immediate remediation isn't possible, add to allowlist with expiration
4. **Document**: Include justification for any allowlisting decisions
5. **Track**: Create issues for allowlisted vulnerabilities that need eventual remediation

## Best Practices

1. **Regular Audits**: Run `npm audit` regularly, not just in CI
2. **Dependency Updates**: Keep dependencies updated to minimize vulnerabilities
3. **Minimize Dependencies**: Be selective about adding dependencies
4. **Use Exact Versions**: Use exact versions in package.json to prevent unexpected updates
5. **Review Allowlist**: Periodically review the allowlist to ensure entries are still valid

## Additional Resources

- [npm audit documentation](https://docs.npmjs.com/cli/v9/commands/npm-audit)
- [OWASP Dependency Management](https://owasp.org/www-project-top-ten/2017/A9_2017-Using_Components_with_Known_Vulnerabilities)
- [Snyk Vulnerability DB](https://security.snyk.io/)
