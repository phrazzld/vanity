# Security Vulnerability Management Guide

## Overview

This document outlines the approach to managing security vulnerabilities in dependencies for the Vanity project. We use npm's built-in audit capabilities enhanced with a custom allowlisting mechanism to manage and track known vulnerabilities.

## Vulnerability Scanning

### Automated Scanning in CI

The project includes automated security vulnerability scanning in the CI pipeline that:

1. Runs on every pull request and push to main
2. Checks for high and critical vulnerabilities using `npm audit`
3. Uses an allowlist mechanism to handle known and accepted vulnerabilities
4. Fails the build when new high or critical vulnerabilities are detected

### Local Scanning

Developers should run security scans locally before submitting pull requests to ensure no new vulnerabilities are introduced. The following npm scripts are available:

```bash
# Run a basic high/critical vulnerability scan
npm run security:audit

# Run the scan with allowlist filtering (same as CI)
npm run security:scan
```

#### Local Security Scan Workflow

As a developer, follow these steps to incorporate security scanning into your workflow:

1. **Pre-coding**: Run a scan before starting work to establish a baseline

   ```bash
   npm run security:scan
   ```

2. **Pre-commit**: Run a scan after adding or updating dependencies

   ```bash
   npm run security:scan
   ```

3. **Pre-PR**: Always run a final scan before submitting your PR

   ```bash
   npm run security:scan
   ```

4. **Handling failures**: If the scan fails, you'll see output indicating which vulnerabilities were detected. These will be non-allowlisted high or critical vulnerabilities.

## Understanding Audit Results

npm audit categorizes vulnerabilities by severity:

- **Low**: Minimal impact, generally safe to defer remediation
- **Moderate**: Notable security impact but typically not exploitable in most contexts
- **High**: Significant security impact, should be prioritized for remediation
- **Critical**: Severe vulnerabilities that require immediate attention

Our CI pipeline fails on **high** and **critical** vulnerabilities only, unless they're in the allowlist.

## Vulnerability Allowlisting

### When to Use Allowlisting

Allowlisting should be used in the following scenarios:

1. A vulnerability exists in a development dependency not used in production
2. A vulnerability is not exploitable in our specific usage context
3. A fix is not yet available, but we have a timeline for remediation

### Allowlist Configuration

The allowlist is managed in `.audit-allowlist.json` in the project root. Each entry includes:

```json
{
  "id": "GHSA-xxxx-xxxx-xxxx",
  "package": "example-package",
  "reason": "Justification for allowing this vulnerability",
  "expires": "2025-12-31T00:00:00Z",
  "notes": "Optional additional context",
  "reviewedOn": "2025-05-20T00:00:00Z"
}
```

**Required fields:**

- `id`: The vulnerability identifier (from npm audit)
- `package`: The package name containing the vulnerability
- `reason`: A clear justification for allowlisting
- `expires`: An ISO 8601 date-time (YYYY-MM-DDTHH:mm:ssZ) when this allowlist entry expires

**Optional fields:**

- `notes`: Additional context or references
- `reviewedOn`: An ISO 8601 date-time when this allowlist entry was last reviewed

### Schema Validation

The allowlist file is automatically validated against a strict JSON schema that enforces:

1. **Required Fields**: All entries must include `id`, `package`, `reason`, and `expires`
2. **Date Format**: All date fields (`expires`, `reviewedOn`) must use ISO 8601 date-time format with timezone (e.g., `2025-12-31T00:00:00Z`)
3. **No Extra Fields**: Additional properties beyond the defined schema are not allowed
4. **Non-Empty Values**: String fields cannot be empty

If validation fails, you'll receive clear error messages indicating exactly what needs to be fixed.

### Adding a New Allowlist Entry

When adding a new entry to the allowlist:

1. Run `npm audit` to identify the vulnerability details
2. Add an entry to `.audit-allowlist.json` with a clear justification
3. **Must include an expiration date-time** - this field is mandatory for accountability
4. Commit the changes with a message that explains the allowlisting decision

### Expiration and Review

**All allowlist entries must have expiration dates** - this is now a mandatory requirement. The expiration date serves as a forcing function to revisit the vulnerability and ensures entries don't persist indefinitely. When an entry expires:

1. The CI build will start failing
2. The team must either:
   - Fix the vulnerability
   - Update the expiration date with justification
   - Remove the entry if it's no longer relevant

## Remediation Workflow

When new vulnerabilities are detected, follow this process:

### 1. Assess Impact

```bash
# Run the full audit to see detailed information
npm audit --json | jq
```

Evaluate each vulnerability:

- Is it in a production or development dependency?
- How severe is it (high/critical)?
- Is it exploitable in our specific usage context?
- Are there known exploits in the wild?

### 2. Remediate When Possible

The preferred approach is always to update the vulnerable dependency:

```bash
# Update a specific package
npm update <package-name>

# Or use npm audit fix for automated remediation
npm audit fix

# For major version updates that might include breaking changes
npm audit fix --force  # Use with caution!
```

After updating, verify your application still works:

- Run the test suite: `npm test`
- Run the application locally: `npm run dev`
- Check for any regressions in functionality

### 3. Allowlist When Necessary

If immediate remediation isn't possible (e.g., waiting for an upstream fix or major refactoring required), add the vulnerability to the allowlist:

1. Identify the vulnerability details:

   ```bash
   npm audit --json | jq '.vulnerabilities'
   ```

2. Add an entry to `.audit-allowlist.json`:

   ```json
   {
     "id": "<vulnerability-id>",
     "package": "<package-name>",
     "reason": "Clear explanation of why this can't be fixed immediately",
     "expires": "YYYY-MM-DDTHH:mm:ssZ", // Set a reasonable expiration (max 60 days)
     "notes": "Reference to tracking issue",
     "reviewedOn": "YYYY-MM-DDTHH:mm:ssZ"
   }
   ```

3. Verify the allowlist works:
   ```bash
   npm run security:scan
   ```

### 4. Document and Track

For each allowlisted vulnerability:

1. Create a tracking issue in your issue tracker with:

   - Vulnerability details
   - Remediation plan
   - Target date for resolution (matching the expiration date)
   - Assignee responsible for follow-up

2. Reference this issue in the `notes` field of the allowlist entry

3. Set a calendar reminder for the expiration date

4. Include the tracking issue number in your PR description when adding to the allowlist

## Developer Responsibilities

Every developer on the team is responsible for:

1. **Running Security Scans**: Before creating PRs and after adding/updating dependencies
2. **Addressing Vulnerabilities**: Fixing or properly allowlisting any vulnerabilities in dependencies they introduce
3. **Reviewing Allowlist Entries**: During code reviews, critically assess any new allowlist entries
4. **Reporting Security Concerns**: Escalate any security concerns to the security team
5. **Keeping Informed**: Stay updated on security best practices and common vulnerability patterns

## Best Practices

1. **Regular Audits**: Run `npm audit` regularly, not just in CI
2. **Dependency Updates**: Keep dependencies updated to minimize vulnerabilities
3. **Minimize Dependencies**: Be selective about adding dependencies
4. **Use Exact Versions**: Use exact versions in package.json to prevent unexpected updates
5. **Review Allowlist**: Periodically review the allowlist to ensure entries are still valid
6. **Automated Monitoring**: Consider integrating with security monitoring tools like Dependabot or Snyk
7. **Security Focused Code Reviews**: Include security considerations in code review checklist

## Additional Resources

- [npm audit documentation](https://docs.npmjs.com/cli/v9/commands/npm-audit)
- [OWASP Dependency Management](https://owasp.org/www-project-top-ten/2017/A9_2017-Using_Components_with_Known_Vulnerabilities)
- [Snyk Vulnerability DB](https://security.snyk.io/)
