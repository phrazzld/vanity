name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing project dependencies..."
          npm ci || {
            echo "âŒ Failed to install dependencies!"
            echo "â†’ Try running 'npm ci' locally to reproduce the issue"
            echo "â†’ Ensure package-lock.json is committed and up to date"
            echo "â†’ Check if you have access to all npm registries"
            exit 1
          }

      - name: Generate Prisma client
        run: |
          echo "ğŸ—„ï¸ Generating Prisma client..."
          npm run prisma:generate || {
            echo "âŒ Failed to generate Prisma client!"
            echo "â†’ Ensure prisma schema is valid"
            echo "â†’ Check prisma/schema.prisma for syntax errors"
            echo "â†’ Run 'npm run prisma:generate' locally to debug"
            exit 1
          }

      # Note: Code formatting check removed - pre-commit hooks ensure formatting
      # This eliminates redundancy while maintaining code quality

      - name: Lint
        run: |
          echo "ğŸ” Running ESLint..."
          npm run lint || {
            echo "âŒ Linting failed!"
            echo ""
            echo "To fix linting issues:"
            echo "1. Review the errors above"
            echo "2. Run 'npm run lint:fix' to auto-fix some issues"
            echo "3. Manually fix remaining issues"
            echo "4. Commit and push your changes"
            echo ""
            echo "ğŸ“š Common issues:"
            echo "â†’ Unused variables: prefix with '_' or remove"
            echo "â†’ Missing return types: add explicit TypeScript types"
            echo "â†’ Import order: let ESLint auto-fix handle this"
            exit 1
          }

      - name: Type check
        run: |
          echo "ğŸ“ Running TypeScript type check..."
          npm run typecheck || {
            echo "âŒ TypeScript type check failed!"
            echo ""
            echo "To fix type errors:"
            echo "1. Review the errors above"
            echo "2. Add missing type annotations"
            echo "3. Fix type mismatches"
            echo "4. Avoid using 'any' type"
            echo ""
            echo "ğŸ’¡ Tips:"
            echo "â†’ Enable strict mode in tsconfig.json"
            echo "â†’ Use VS Code for real-time type checking"
            echo "â†’ Check DEVELOPMENT_PHILOSOPHY_APPENDIX_TYPESCRIPT.md"
            exit 1
          }

      - name: Strict TypeScript checking
        run: |
          echo "ğŸ” Running strict TypeScript checking..."
          npm run typecheck || {
            echo "âŒ Strict TypeScript checking failed!"
            echo ""
            echo "To fix strict type violations:"
            echo "1. Address unused variables (prefix with '_' or remove)"
            echo "2. Add explicit return types where required"
            echo "3. Fix unsafe indexed access patterns"
            echo "4. Resolve implicit any types"
            echo ""
            echo "ğŸ’¡ This step enforces higher code quality standards"
            echo "â†’ See tsconfig.typecheck.json for strict rules"
            echo "â†’ Run 'npm run typecheck' locally to test"
            exit 1
          }

      - name: Run tests with coverage
        run: |
          echo "ğŸ§ª Running tests with coverage..."
          npm run test:coverage || {
            echo "âŒ Tests failed!"
            echo ""
            echo "To debug test failures:"
            echo "1. Run 'npm test' locally"
            echo "2. For specific test: 'npm test -- path/to/test'"
            echo "3. Update snapshots if needed: 'npm test -- -u'"
            echo "4. Check test coverage thresholds in jest.config.js"
            echo ""
            echo "ğŸ“Š Coverage requirements:"
            echo "â†’ Global: 27% minimum (temporarily lowered from 85%)"
            echo "â†’ Core logic (api/, lib/): 17-36% minimum (temporarily lowered from 90%)"
            echo "â†’ See BACKLOG.md for coverage improvement plan"
            exit 1
          }

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      # Note: Edge Runtime compatibility check removed - pre-push hook covers this
      # This eliminates duplication while maintaining comprehensive validation

      - name: Build
        run: |
          echo "ğŸ”¨ Building Next.js application..."
          npm run build || {
            echo "âŒ Build failed!"
            echo ""
            echo "To fix build issues:"
            echo "1. Run 'npm run build' locally"
            echo "2. Check for TypeScript errors"
            echo "3. Verify all imports are correct"
            echo "4. Ensure environment variables are set"
            echo ""
            echo "ğŸ’¡ Common build issues:"
            echo "â†’ Missing environment variables"
            echo "â†’ Import errors in production-only code"
            echo "â†’ TypeScript errors not caught in dev mode"
            echo "â†’ Edge Runtime compatibility issues"
            echo "â†’ Invalid Tailwind CSS classes"
            exit 1
          }

      - name: Build Storybook
        run: |
          echo "ğŸ“š Building Storybook..."
          npm run build-storybook || {
            echo "âŒ Storybook build failed!"
            echo ""
            echo "To fix Storybook build issues:"
            echo "1. Run 'npm run storybook' locally"
            echo "2. Check for story syntax errors"
            echo "3. Verify all component imports"
            echo "4. Review .storybook configuration"
            echo ""
            echo "ğŸ“– See STORYBOOK_GUIDELINES.md for help"
            exit 1
          }

  security_scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing project dependencies..."
          npm ci || {
            echo "âŒ Failed to install dependencies!"
            echo "â†’ Try running 'npm ci' locally to reproduce the issue"
            echo "â†’ Ensure package-lock.json is committed and up to date"
            exit 1
          }

      - name: Build security audit filter script
        run: |
          echo "ğŸ”§ Building security audit filter script..."
          npm run build:audit-filter || {
            echo "âŒ Failed to build audit filter script!"
            echo "â†’ Check TypeScript errors in scripts/audit-filter.ts"
            exit 1
          }

      - name: Run security scan with allowlist filtering
        run: |
          echo "ğŸ”’ Checking for non-allowlisted high and critical security vulnerabilities..."
          node dist/scripts/audit-filter.js || {
            echo "âŒ Security vulnerabilities detected!"
            echo ""
            echo "To fix security issues:"
            echo "1. Update dependencies to resolve vulnerabilities"
            echo "2. OR add entries to .audit-allowlist.json with proper justification"
            echo ""
            echo "ğŸ’¡ Allowlist entries must include:"
            echo "â†’ Package name and vulnerability ID"
            echo "â†’ Clear justification for why it's being allowlisted"
            echo "â†’ Expiration date for when it should be fixed"
            echo ""
            echo "See docs/SECURITY_VULNERABILITY_MANAGEMENT.md for details"
            exit 1
          }
