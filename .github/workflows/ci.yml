name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing project dependencies..."
          npm ci || {
            echo "âŒ Failed to install dependencies!"
            echo "â†’ Try running 'npm ci' locally to reproduce the issue"
            echo "â†’ Ensure package-lock.json is committed and up to date"
            echo "â†’ Check if you have access to all npm registries"
            exit 1
          }

      - name: Generate Prisma client
        run: |
          echo "ğŸ—„ï¸ Generating Prisma client..."
          npm run prisma:generate || {
            echo "âŒ Failed to generate Prisma client!"
            echo "â†’ Ensure prisma schema is valid"
            echo "â†’ Check prisma/schema.prisma for syntax errors"
            echo "â†’ Run 'npm run prisma:generate' locally to debug"
            exit 1
          }

      - name: Check formatting
        run: |
          echo "ğŸ¨ Checking code formatting..."
          npm run format:check || {
            echo "âŒ Code formatting check failed!"
            echo ""
            echo "To fix formatting issues:"
            echo "1. Run 'npm run format' locally"
            echo "2. Commit the formatted files"
            echo "3. Push your changes"
            echo ""
            echo "ğŸ’¡ Tip: Enable format-on-save in VS Code"
            echo "   See .vscode/settings.json for recommended settings"
            exit 1
          }

      - name: Lint
        run: |
          echo "ğŸ” Running ESLint..."
          npm run lint || {
            echo "âŒ Linting failed!"
            echo ""
            echo "To fix linting issues:"
            echo "1. Review the errors above"
            echo "2. Run 'npm run lint:fix' to auto-fix some issues"
            echo "3. Manually fix remaining issues"
            echo "4. Commit and push your changes"
            echo ""
            echo "ğŸ“š Common issues:"
            echo "â†’ Unused variables: prefix with '_' or remove"
            echo "â†’ Missing return types: add explicit TypeScript types"
            echo "â†’ Import order: let ESLint auto-fix handle this"
            exit 1
          }

      - name: Type check
        run: |
          echo "ğŸ“ Running TypeScript type check..."
          npm run typecheck || {
            echo "âŒ TypeScript type check failed!"
            echo ""
            echo "To fix type errors:"
            echo "1. Review the errors above"
            echo "2. Add missing type annotations"
            echo "3. Fix type mismatches"
            echo "4. Avoid using 'any' type"
            echo ""
            echo "ğŸ’¡ Tips:"
            echo "â†’ Enable strict mode in tsconfig.json"
            echo "â†’ Use VS Code for real-time type checking"
            echo "â†’ Check DEVELOPMENT_PHILOSOPHY_APPENDIX_TYPESCRIPT.md"
            exit 1
          }

      - name: Run tests with coverage
        run: |
          echo "ğŸ§ª Running tests with coverage..."
          npm run test:coverage || {
            echo "âŒ Tests failed!"
            echo ""
            echo "To debug test failures:"
            echo "1. Run 'npm test' locally"
            echo "2. For specific test: 'npm test -- path/to/test'"
            echo "3. Update snapshots if needed: 'npm test -- -u'"
            echo "4. Check test coverage thresholds in jest.config.js"
            echo ""
            echo "ğŸ“Š Coverage requirements:"
            echo "â†’ Global: 85% minimum"
            echo "â†’ Core logic (api/, lib/): 90% minimum"
            exit 1
          }

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      - name: Build
        run: |
          echo "ğŸ”¨ Building Next.js application..."
          npm run build || {
            echo "âŒ Build failed!"
            echo ""
            echo "To fix build issues:"
            echo "1. Run 'npm run build' locally"
            echo "2. Check for TypeScript errors"
            echo "3. Verify all imports are correct"
            echo "4. Ensure environment variables are set"
            echo ""
            echo "ğŸ’¡ Common build issues:"
            echo "â†’ Missing environment variables"
            echo "â†’ Import errors in production-only code"
            echo "â†’ TypeScript errors not caught in dev mode"
            exit 1
          }

      - name: Build Storybook
        run: |
          echo "ğŸ“š Building Storybook..."
          npm run build-storybook || {
            echo "âŒ Storybook build failed!"
            echo ""
            echo "To fix Storybook build issues:"
            echo "1. Run 'npm run storybook' locally"
            echo "2. Check for story syntax errors"
            echo "3. Verify all component imports"
            echo "4. Review .storybook configuration"
            echo ""
            echo "ğŸ“– See STORYBOOK_GUIDELINES.md for help"
            exit 1
          }
