name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing project dependencies with pnpm..."
          pnpm install --frozen-lockfile || {
            echo "âŒ Failed to install dependencies!"
            echo "â†’ Try running 'pnpm install --frozen-lockfile' locally to reproduce the issue"
            echo "â†’ Ensure pnpm-lock.yaml is committed and up to date"
            exit 1
          }

      # Note: Code formatting check removed - pre-commit hooks ensure formatting
      # This eliminates redundancy while maintaining code quality

      - name: Lint
        run: |
          echo "ğŸ” Running ESLint..."
          pnpm run lint || {
            echo "âŒ Linting failed!"
            echo ""
            echo "To fix linting issues:"
            echo "1. Review the errors above"
            echo "2. Run 'pnpm run lint:fix' to auto-fix some issues"
            echo "3. Manually fix remaining issues"
            echo "4. Commit and push your changes"
            echo ""
            echo "ğŸ“š Common issues:"
            echo "â†’ Unused variables: prefix with '_' or remove"
            echo "â†’ Missing return types: add explicit TypeScript types"
            echo "â†’ Import order: let ESLint auto-fix handle this"
            exit 1
          }

      - name: Generate static data
        run: |
          echo "ğŸ“Š Generating static data files for type checking..."
          node scripts/generate-static-data.js
          echo "âœ… Static data generated successfully"

      - name: Type check
        run: |
          echo "ğŸ“ Running TypeScript type check..."
          pnpm run typecheck || {
            echo "âŒ TypeScript type check failed!"
            echo ""
            echo "To fix type errors:"
            echo "1. Review the errors above"
            echo "2. Add missing type annotations"
            echo "3. Fix type mismatches"
            echo "4. Avoid using 'any' type"
            echo ""
            echo "ğŸ’¡ Tips:"
            echo "â†’ Enable strict mode in tsconfig.json"
            echo "â†’ Use VS Code for real-time type checking"
            echo "â†’ Check DEVELOPMENT_PHILOSOPHY_APPENDIX_TYPESCRIPT.md"
            exit 1
          }

      - name: Run tests with coverage
        run: |
          echo "ğŸ§ª Running tests with coverage..."
          pnpm run test:coverage || {
            echo "âŒ Tests failed!"
            echo ""
            echo "To debug test failures:"
            echo "1. Run 'pnpm test' locally"
            echo "2. For specific test: 'pnpm test -- path/to/test'"
            echo "3. Update snapshots if needed: 'pnpm test -- -u'"
            echo "4. Review coverage report in CI artifacts"
            exit 1
          }

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      # Note: Edge Runtime compatibility check removed - pre-push hook covers this
      # This eliminates duplication while maintaining comprehensive validation

      - name: Build
        run: |
          echo "ğŸ”¨ Building Next.js application..."
          pnpm run build || {
            echo "âŒ Build failed!"
            echo ""
            echo "To fix build issues:"
            echo "1. Run 'pnpm run build' locally"
            echo "2. Check for TypeScript errors"
            echo "3. Verify all imports are correct"
            echo "4. Ensure environment variables are set"
            echo ""
            echo "ğŸ’¡ Common build issues:"
            echo "â†’ Missing environment variables"
            echo "â†’ Import errors in production-only code"
            echo "â†’ TypeScript errors not caught in dev mode"
            echo "â†’ Edge Runtime compatibility issues"
            echo "â†’ Invalid Tailwind CSS classes"
            exit 1
          }

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: next-build
          path: .next/
          retention-days: 1

  security_scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    # Runs in parallel with build-and-test for faster feedback

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing project dependencies with pnpm..."
          pnpm install --frozen-lockfile || {
            echo "âŒ Failed to install dependencies!"
            echo "â†’ Try running 'pnpm install --frozen-lockfile' locally to reproduce the issue"
            echo "â†’ Ensure pnpm-lock.yaml is committed and up to date"
            exit 1
          }

      - name: Run security scan
        run: |
          echo "ğŸ”’ Checking for critical security vulnerabilities..."
          pnpm run security:audit || {
            echo "âŒ Critical security vulnerabilities detected!"
            echo ""
            echo "To fix:"
            echo "1. Run 'pnpm audit' locally to see details"
            echo "2. Update dependencies with 'pnpm update'"
            echo "3. For breaking changes, manually update package.json"
            exit 1
          }
          echo "âœ… No critical vulnerabilities found"
